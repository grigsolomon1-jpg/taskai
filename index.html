<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0a0a0f">
  <title>TaskAI</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--bg:#0a0a0f;--surface:#13131a;--elevated:#1c1c26;--border:#2d2d3a;--text:#f0f0f5;--text2:#9090a0;--purple:#8b5cf6;--blue:#3b82f6;--red:#ef4444;--orange:#f97316;--green:#22c55e}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;min-height:100dvh}
    .app{max-width:500px;margin:0 auto;min-height:100vh;min-height:100dvh;display:flex;flex-direction:column}
    
    header{padding:16px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);background:rgba(10,10,15,0.95);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);position:sticky;top:0;z-index:100}
    .logo{display:flex;align-items:center;gap:10px;font-weight:700;font-size:20px}
    .logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--blue),var(--purple));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px}
    .header-btn{width:40px;height:40px;border:1px solid var(--border);background:var(--elevated);border-radius:10px;color:var(--text2);font-size:18px;cursor:pointer}
    
    .stats{padding:16px 20px;display:flex;gap:10px}
    .stat{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center}
    .stat-num{font-size:24px;font-weight:700}
    .stat-num.urgent{color:var(--red)}.stat-num.today{color:var(--orange)}.stat-num.done{color:var(--green)}
    .stat-label{font-size:11px;color:var(--text2);margin-top:4px}
    
    .input-section{padding:16px 20px;display:flex;gap:10px}
    .voice-btn{width:50px;height:50px;border-radius:14px;border:none;background:linear-gradient(135deg,var(--blue),var(--purple));color:white;font-size:22px;cursor:pointer;flex-shrink:0}
    .voice-btn.listening{animation:pulse 1.5s infinite}
    @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(139,92,246,0.4)}50%{box-shadow:0 0 0 12px rgba(139,92,246,0)}}
    .text-input{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:14px 16px;color:var(--text);font-size:16px;outline:none}
    .text-input:focus{border-color:var(--purple)}
    .text-input::placeholder{color:var(--text2)}
    .send-btn{width:50px;height:50px;background:var(--purple);border:none;border-radius:14px;color:white;font-size:20px;cursor:pointer;flex-shrink:0}
    
    .processing{padding:10px 20px;color:var(--purple);font-size:14px;display:none;align-items:center;gap:8px}
    .processing.show{display:flex}
    .spinner{width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--purple);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    .tasks-section{flex:1;padding:0 20px 120px;overflow-y:auto}
    .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;position:sticky;top:0;background:var(--bg);padding:10px 0;z-index:10}
    .section-title{font-size:18px;font-weight:600}
    .filters{display:flex;gap:6px}
    .filter{padding:6px 14px;background:var(--surface);border:1px solid var(--border);border-radius:20px;font-size:13px;color:var(--text2);cursor:pointer}
    .filter.active{background:var(--purple);border-color:var(--purple);color:white}
    
    .task-list{display:flex;flex-direction:column;gap:10px}
    .task{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:16px;cursor:pointer;transition:border-color 0.2s}
    .task:hover{border-color:var(--purple)}
    .task.done{opacity:0.5}
    .task-header{display:flex;gap:12px;align-items:flex-start}
    .checkbox{width:24px;height:24px;border:2px solid var(--border);border-radius:7px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.2s}
    .checkbox:hover{border-color:var(--green)}
    .task.done .checkbox{background:var(--green);border-color:var(--green)}
    .checkbox::after{content:'‚úì';color:white;font-size:14px;font-weight:700;opacity:0}
    .task.done .checkbox::after{opacity:1}
    .task-content{flex:1;min-width:0}
    .task-title{font-size:16px;font-weight:500;line-height:1.4}
    .task.done .task-title{text-decoration:line-through;color:var(--text2)}
    .task-meta{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
    .badge{padding:4px 10px;border-radius:8px;font-size:12px;font-weight:500}
    .badge.urgent{background:rgba(239,68,68,0.15);color:var(--red)}
    .badge.high{background:rgba(249,115,22,0.15);color:var(--orange)}
    .badge.medium{background:rgba(59,130,246,0.15);color:var(--blue)}
    .badge.low{background:rgba(34,197,94,0.15);color:var(--green)}
    .badge.deadline{background:var(--elevated);color:var(--text2)}
    .badge.overdue{background:rgba(239,68,68,0.15);color:var(--red)}
    
    .empty{text-align:center;padding:60px 20px;color:var(--text2)}
    .empty-icon{font-size:48px;margin-bottom:16px;opacity:0.5}
    .empty-title{font-size:16px;margin-bottom:8px;color:var(--text)}
    
    /* Modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:200;display:none;align-items:flex-end;justify-content:center}
    .modal-overlay.open{display:flex}
    .modal{background:var(--surface);border-radius:24px 24px 0 0;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;animation:slideUp 0.3s}
    @keyframes slideUp{from{transform:translateY(100%)}}
    .modal-header{padding:20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:var(--surface);z-index:10}
    .modal-title{font-size:18px;font-weight:600}
    .modal-close{width:36px;height:36px;border:none;background:var(--elevated);border-radius:10px;color:var(--text);font-size:20px;cursor:pointer}
    .modal-body{padding:20px}
    
    .form-group{margin-bottom:20px}
    .form-label{font-size:14px;color:var(--text2);margin-bottom:8px;display:block}
    .form-input{width:100%;background:var(--elevated);border:1px solid var(--border);border-radius:12px;padding:14px 16px;color:var(--text);font-size:16px;outline:none}
    .form-input:focus{border-color:var(--purple)}
    .form-textarea{min-height:100px;resize:vertical;font-family:inherit}
    
    .priority-selector{display:flex;gap:8px}
    .priority-btn{flex:1;padding:12px;border:1px solid var(--border);background:var(--elevated);border-radius:10px;color:var(--text2);font-size:13px;cursor:pointer;text-align:center}
    .priority-btn.active{border-color:var(--purple);color:var(--text)}
    .priority-btn.urgent.active{border-color:var(--red);background:rgba(239,68,68,0.1);color:var(--red)}
    .priority-btn.high.active{border-color:var(--orange);background:rgba(249,115,22,0.1);color:var(--orange)}
    .priority-btn.medium.active{border-color:var(--blue);background:rgba(59,130,246,0.1);color:var(--blue)}
    .priority-btn.low.active{border-color:var(--green);background:rgba(34,197,94,0.1);color:var(--green)}
    
    .modal-actions{display:flex;gap:10px;margin-top:24px}
    .btn{flex:1;padding:16px;border:none;border-radius:14px;font-size:16px;font-weight:600;cursor:pointer}
    .btn-primary{background:var(--purple);color:white}
    .btn-danger{background:rgba(239,68,68,0.15);color:var(--red)}
    .btn-secondary{background:var(--elevated);color:var(--text)}
    
    /* Chat */
    .chat-modal{position:fixed;inset:0;background:var(--bg);z-index:200;display:flex;flex-direction:column;transform:translateX(100%);transition:transform 0.3s}
    .chat-modal.open{transform:translateX(0)}
    .chat-header{padding:16px 20px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border);background:var(--bg)}
    .back-btn{width:40px;height:40px;background:var(--elevated);border:none;border-radius:10px;color:var(--text);font-size:18px;cursor:pointer}
    .chat-messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:12px}
    .suggestions{display:flex;flex-direction:column;gap:8px}
    .suggestion{padding:14px 16px;background:var(--surface);border:1px solid var(--border);border-radius:14px;font-size:14px;color:var(--text2);cursor:pointer;text-align:left}
    .suggestion:hover{border-color:var(--purple);color:var(--text)}
    .chat-msg{max-width:85%}
    .chat-msg.user{align-self:flex-end}
    .chat-msg.assistant{align-self:flex-start}
    .bubble{padding:14px 18px;border-radius:18px;font-size:15px;line-height:1.5;white-space:pre-wrap}
    .chat-msg.user .bubble{background:var(--purple);border-bottom-right-radius:4px}
    .chat-msg.assistant .bubble{background:var(--surface);border:1px solid var(--border);border-bottom-left-radius:4px}
    .chat-input-area{padding:16px 20px;border-top:1px solid var(--border);display:flex;gap:10px;background:var(--bg)}
    .chat-input{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:14px 16px;color:var(--text);font-size:16px;outline:none}
    .chat-send{width:50px;height:50px;background:var(--purple);border:none;border-radius:14px;color:white;font-size:20px;cursor:pointer}
    
    /* Bottom Nav */
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:rgba(10,10,15,0.95);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:1px solid var(--border);display:flex;justify-content:center;padding:10px 20px;padding-bottom:max(10px,env(safe-area-inset-bottom))}
    .nav-btn{flex:1;max-width:120px;padding:10px;background:none;border:none;border-radius:12px;color:var(--text2);font-size:12px;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px}
    .nav-btn.active{color:var(--purple);background:rgba(139,92,246,0.1)}
    .nav-icon{font-size:22px}
    
    .toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:var(--elevated);border:1px solid var(--border);padding:14px 24px;border-radius:14px;font-size:14px;z-index:300}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo"><div class="logo-icon">‚ö°</div><span>TaskAI</span></div>
      <button class="header-btn" onclick="openChat()">üí¨</button>
    </header>
    
    <div class="stats">
      <div class="stat"><div class="stat-num urgent" id="urgentCount">0</div><div class="stat-label">–°—Ä–æ—á–Ω—ã—Ö</div></div>
      <div class="stat"><div class="stat-num today" id="todayCount">0</div><div class="stat-label">–ù–∞ —Å–µ–≥–æ–¥–Ω—è</div></div>
      <div class="stat"><div class="stat-num done" id="doneCount">0</div><div class="stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div></div>
    </div>
    
    <div class="input-section">
      <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()">üé§</button>
      <input type="text" class="text-input" id="textInput" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É..." onkeypress="if(event.key==='Enter')sendText()">
      <button class="send-btn" onclick="sendText()">+</button>
    </div>
    
    <div class="processing" id="processing"><div class="spinner"></div><span>AI –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç...</span></div>
    
    <div class="tasks-section">
      <div class="section-header">
        <h2 class="section-title">–ú–æ–∏ –∑–∞–¥–∞—á–∏</h2>
        <div class="filters">
          <button class="filter active" data-f="active" onclick="setFilter('active')">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
          <button class="filter" data-f="done" onclick="setFilter('done')">–ì–æ—Ç–æ–≤—ã–µ</button>
        </div>
      </div>
      <div class="task-list" id="taskList"></div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É</span>
        <button class="modal-close" onclick="closeEditModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input type="text" class="form-input" id="editTitle">
        </div>
        <div class="form-group">
          <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea class="form-input form-textarea" id="editDesc" placeholder="–î–æ–±–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
          <div class="priority-selector">
            <button class="priority-btn urgent" data-p="urgent" onclick="setPriority('urgent')">üî¥ –°—Ä–æ—á–Ω–æ</button>
            <button class="priority-btn high" data-p="high" onclick="setPriority('high')">üü† –í–∞–∂–Ω–æ</button>
            <button class="priority-btn medium" data-p="medium" onclick="setPriority('medium')">üîµ –û–±—ã—á–Ω–æ</button>
            <button class="priority-btn low" data-p="low" onclick="setPriority('low')">üü¢ –ü–æ–∑–∂–µ</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">–î–µ–¥–ª–∞–π–Ω</label>
          <input type="date" class="form-input" id="editDeadline">
        </div>
        <div class="modal-actions">
          <button class="btn btn-danger" onclick="deleteTask()">–£–¥–∞–ª–∏—Ç—å</button>
          <button class="btn btn-primary" onclick="saveTask()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Modal -->
  <div class="chat-modal" id="chatModal">
    <div class="chat-header">
      <button class="back-btn" onclick="closeChat()">‚Üê</button>
      <span style="font-weight:600;font-size:18px">AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</span>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="suggestions" id="suggestions">
        <button class="suggestion" onclick="askQ(this)">üìä –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –º–æ–∏ –∑–∞–¥–∞—á–∏</button>
        <button class="suggestion" onclick="askQ(this)">üéØ –° —á–µ–≥–æ –Ω–∞—á–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è?</button>
        <button class="suggestion" onclick="askQ(this)">‚ö†Ô∏è –ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ –ø–æ–¥ —É–≥—Ä–æ–∑–æ–π?</button>
        <button class="suggestion" onclick="askQ(this)">üìÖ –°–ø–ª–∞–Ω–∏—Ä—É–π –º–æ–π –¥–µ–Ω—å</button>
      </div>
    </div>
    <div class="chat-input-area">
      <input type="text" class="chat-input" id="chatInput" placeholder="–°–ø—Ä–æ—Å–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å..." onkeypress="if(event.key==='Enter')sendChat()">
      <button class="chat-send" onclick="sendChat()">‚Üí</button>
    </div>
  </div>

  <nav class="bottom-nav">
    <button class="nav-btn active"><span class="nav-icon">üìã</span><span>–ó–∞–¥–∞—á–∏</span></button>
    <button class="nav-btn" onclick="openChat()"><span class="nav-icon">ü§ñ</span><span>AI</span></button>
  </nav>

  <script>
    const API='/api/chat';
    let tasks=JSON.parse(localStorage.getItem('taskai2')||'[]');
    let filter='active';
    let listening=false;
    let recognition=null;
    let chatHistory=[];
    let editingId=null;
    let editPriority='medium';

    renderTasks();
    updateStats();
    setupSpeech();

    function setupSpeech(){
      if('webkitSpeechRecognition' in window||'SpeechRecognition' in window){
        const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
        recognition=new SR();
        recognition.continuous=true;
        recognition.interimResults=true;
        recognition.lang='ru-RU';
        recognition.onresult=e=>{
          let t='';
          for(let i=0;i<e.results.length;i++)t+=e.results[i][0].transcript;
          document.getElementById('textInput').value=t;
        };
        recognition.onerror=()=>stopVoice();
        recognition.onend=()=>{
          if(listening){
            const t=document.getElementById('textInput').value;
            if(t.trim())processInput(t);
            stopVoice();
          }
        };
      }
    }

    function toggleVoice(){listening?recognition.stop():startVoice()}
    
    function startVoice(){
      listening=true;
      document.getElementById('voiceBtn').classList.add('listening');
      document.getElementById('textInput').placeholder='–ì–æ–≤–æ—Ä–∏—Ç–µ...';
      recognition.start();
    }
    
    function stopVoice(){
      listening=false;
      document.getElementById('voiceBtn').classList.remove('listening');
      document.getElementById('textInput').placeholder='–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É...';
    }

    async function processInput(text){
      if(!text.trim())return;
      document.getElementById('processing').classList.add('show');
      document.getElementById('textInput').value='';
      
      try{
        const res=await fetch(API,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({mode:'parse',messages:[{role:'user',content:text}]})
        });
        const data=await res.json();
        
        if(data.error){
          toast('‚ùå '+data.error);
          throw new Error(data.error);
        }
        
        let newTasks=[];
        try{
          const match=data.content.match(/\[[\s\S]*\]/);
          if(match)newTasks=JSON.parse(match[0]);
        }catch(e){console.log('Parse error',e)}
        
        if(newTasks.length){
          newTasks.forEach(t=>{
            tasks.push({
              id:Date.now()+Math.random(),
              title:t.title||text,
              description:t.description||'',
              priority:t.priority||'medium',
              deadline:t.deadline||null,
              category:t.category||'other',
              status:'active',
              created:new Date().toISOString()
            });
          });
          save();
          renderTasks();
          updateStats();
          toast('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: '+newTasks.length);
        }else{
          // –ï—Å–ª–∏ AI –Ω–µ —Ä–∞—Å–ø–∞—Ä—Å–∏–ª, –¥–æ–±–∞–≤–∏–º –∫–∞–∫ –µ—Å—Ç—å
          tasks.push({
            id:Date.now(),
            title:text,
            description:'',
            priority:'medium',
            deadline:null,
            category:'other',
            status:'active',
            created:new Date().toISOString()
          });
          save();
          renderTasks();
          updateStats();
          toast('‚úÖ –ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
        }
      }catch(e){
        console.error(e);
        // –î–æ–±–∞–≤–∏–º –∑–∞–¥–∞—á—É –±–µ–∑ AI
        tasks.push({
          id:Date.now(),
          title:text,
          description:'',
          priority:'medium',
          deadline:null,
          category:'other',
          status:'active',
          created:new Date().toISOString()
        });
        save();
        renderTasks();
        updateStats();
        toast('‚úÖ –ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
      }
      
      document.getElementById('processing').classList.remove('show');
    }

    function sendText(){
      const inp=document.getElementById('textInput');
      const t=inp.value.trim();
      if(t)processInput(t);
    }

    function save(){localStorage.setItem('taskai2',JSON.stringify(tasks))}

    function renderTasks(){
      const list=document.getElementById('taskList');
      let f=tasks.filter(t=>filter==='active'?t.status!=='done':t.status==='done');
      
      const prio={urgent:0,high:1,medium:2,low:3};
      f.sort((a,b)=>{
        if(prio[a.priority]!==prio[b.priority])return prio[a.priority]-prio[b.priority];
        if(a.deadline&&b.deadline)return new Date(a.deadline)-new Date(b.deadline);
        if(a.deadline)return -1;
        if(b.deadline)return 1;
        return new Date(b.created)-new Date(a.created);
      });
      
      if(!f.length){
        list.innerHTML=`<div class="empty"><div class="empty-icon">üìù</div><div class="empty-title">${filter==='done'?'–ù–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö':'–ù–µ—Ç –∑–∞–¥–∞—á'}</div><div>–ù–∞–∂–º–∏ –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω –∏–ª–∏ –Ω–∞–ø–∏—à–∏ –∑–∞–¥–∞—á—É</div></div>`;
        return;
      }
      
      const prioLabels={urgent:'üî¥ –°—Ä–æ—á–Ω–æ',high:'üü† –í–∞–∂–Ω–æ',medium:'üîµ –û–±—ã—á–Ω–æ',low:'üü¢ –ü–æ–∑–∂–µ'};
      
      list.innerHTML=f.map(t=>{
        const dl=deadlineInfo(t.deadline);
        return`<div class="task ${t.status==='done'?'done':''}" onclick="openEdit(${t.id})">
          <div class="task-header">
            <div class="checkbox" onclick="event.stopPropagation();toggle(${t.id})"></div>
            <div class="task-content">
              <div class="task-title">${esc(t.title)}</div>
              <div class="task-meta">
                <span class="badge ${t.priority}">${prioLabels[t.priority]}</span>
                ${t.deadline?`<span class="badge deadline ${dl.cls}">üìÖ ${dl.text}</span>`:''}
              </div>
            </div>
          </div>
        </div>`;
      }).join('');
    }

    function deadlineInfo(d){
      if(!d)return{text:'',cls:''};
      const date=new Date(d);
      const today=new Date();
      today.setHours(0,0,0,0);
      const diff=Math.ceil((date-today)/86400000);
      if(diff<0)return{text:'–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ',cls:'overdue'};
      if(diff===0)return{text:'–°–µ–≥–æ–¥–Ω—è',cls:'overdue'};
      if(diff===1)return{text:'–ó–∞–≤—Ç—Ä–∞',cls:''};
      if(diff<=7)return{text:diff+' –¥–Ω.',cls:''};
      return{text:date.toLocaleDateString('ru-RU',{day:'numeric',month:'short'}),cls:''};
    }

    function toggle(id){
      const t=tasks.find(x=>x.id===id);
      if(t){
        t.status=t.status==='done'?'active':'done';
        save();
        renderTasks();
        updateStats();
      }
    }

    function setFilter(f){
      filter=f;
      document.querySelectorAll('.filter').forEach(el=>el.classList.toggle('active',el.dataset.f===f));
      renderTasks();
    }

    function updateStats(){
      const active=tasks.filter(t=>t.status!=='done');
      document.getElementById('urgentCount').textContent=active.filter(t=>t.priority==='urgent').length;
      const today=new Date();
      today.setHours(0,0,0,0);
      const tom=new Date(today);
      tom.setDate(tom.getDate()+1);
      document.getElementById('todayCount').textContent=active.filter(t=>t.deadline&&new Date(t.deadline)>=today&&new Date(t.deadline)<tom).length;
      document.getElementById('doneCount').textContent=tasks.filter(t=>t.status==='done').length;
    }

    // Edit Modal
    function openEdit(id){
      const t=tasks.find(x=>x.id===id);
      if(!t)return;
      editingId=id;
      editPriority=t.priority;
      document.getElementById('editTitle').value=t.title;
      document.getElementById('editDesc').value=t.description||'';
      document.getElementById('editDeadline').value=t.deadline||'';
      document.querySelectorAll('.priority-btn').forEach(b=>b.classList.toggle('active',b.dataset.p===t.priority));
      document.getElementById('editModal').classList.add('open');
    }

    function closeEditModal(){
      document.getElementById('editModal').classList.remove('open');
      editingId=null;
    }

    function setPriority(p){
      editPriority=p;
      document.querySelectorAll('.priority-btn').forEach(b=>b.classList.toggle('active',b.dataset.p===p));
    }

    function saveTask(){
      const t=tasks.find(x=>x.id===editingId);
      if(!t)return;
      t.title=document.getElementById('editTitle').value.trim()||t.title;
      t.description=document.getElementById('editDesc').value.trim();
      t.priority=editPriority;
      t.deadline=document.getElementById('editDeadline').value||null;
      save();
      renderTasks();
      updateStats();
      closeEditModal();
      toast('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
    }

    function deleteTask(){
      if(!editingId)return;
      tasks=tasks.filter(x=>x.id!==editingId);
      save();
      renderTasks();
      updateStats();
      closeEditModal();
      toast('üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ');
    }

    // Chat
    function openChat(){document.getElementById('chatModal').classList.add('open')}
    function closeChat(){document.getElementById('chatModal').classList.remove('open')}

    function askQ(btn){
      document.getElementById('chatInput').value=btn.textContent.replace(/^[^\s]+\s/,'');
      sendChat();
    }

    async function sendChat(){
      const inp=document.getElementById('chatInput');
      const msg=inp.value.trim();
      if(!msg)return;
      
      inp.value='';
      chatHistory.push({role:'user',content:msg});
      renderChatMsg();
      document.getElementById('suggestions').style.display='none';
      
      const summary=tasks.map(t=>{
        const st=t.status==='done'?'‚úÖ':'‚¨ú';
        const dl=t.deadline?' (–¥–æ '+t.deadline+')':'';
        const pr={urgent:'–°–†–û–ß–ù–û',high:'–≤–∞–∂–Ω–æ',medium:'–æ–±—ã—á–Ω–æ',low:'–Ω–µ —Å—Ä–æ—á–Ω–æ'}[t.priority];
        return st+' ['+pr+'] '+t.title+dl;
      }).join('\n');
      
      const sys='–¢—ã AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∞–º–∏. –°–µ–≥–æ–¥–Ω—è: '+new Date().toLocaleDateString('ru-RU')+'\n\n–ó–∞–¥–∞—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n'+(summary||'–ù–µ—Ç –∑–∞–¥–∞—á')+'\n\n–ü–æ–º–æ–≥–∞–π —Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º, –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–µ–π, –¥–∞–≤–∞–π —Å–æ–≤–µ—Ç—ã. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏.';
      
      try{
        const res=await fetch(API,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({system:sys,messages:chatHistory})
        });
        const data=await res.json();
        if(data.error)throw new Error(data.error);
        chatHistory.push({role:'assistant',content:data.content});
        renderChatMsg();
      }catch(e){
        chatHistory.push({role:'assistant',content:'‚ùå –û—à–∏–±–∫–∞: '+e.message});
        renderChatMsg();
      }
    }

    function renderChatMsg(){
      const c=document.getElementById('chatMessages');
      c.innerHTML=chatHistory.map(m=>'<div class="chat-msg '+m.role+'"><div class="bubble">'+esc(m.content)+'</div></div>').join('');
      c.scrollTop=c.scrollHeight;
    }

    function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
    function toast(msg){const t=document.createElement('div');t.className='toast';t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),2500)}
    
    // Close modal on overlay click
    document.getElementById('editModal').addEventListener('click',e=>{if(e.target.id==='editModal')closeEditModal()});
  </script>
</body>
</html>
