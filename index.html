<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#f8fafc">
  <title>TaskAI</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--bg:#f8fafc;--surface:#ffffff;--border:#e2e8f0;--text:#1e293b;--text2:#64748b;--purple:#7c3aed;--red:#dc2626;--orange:#ea580c;--blue:#3b82f6;--green:#16a34a;--yellow:#ca8a04}
    body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
    .app{max-width:500px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column}
    
    header{padding:14px 16px;display:flex;align-items:center;justify-content:space-between;background:#fff;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
    .logo{display:flex;align-items:center;gap:8px;font-weight:700;font-size:18px;color:var(--purple)}
    .logo-icon{width:32px;height:32px;background:linear-gradient(135deg,var(--purple),var(--blue));border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px}
    .header-btn{width:36px;height:36px;border:1px solid var(--border);background:#fff;border-radius:8px;font-size:16px;cursor:pointer}
    
    .stats{padding:12px;display:flex;gap:8px;background:#fff;border-bottom:1px solid var(--border)}
    .stat{flex:1;background:#f8fafc;border:2px solid transparent;border-radius:10px;padding:8px 4px;text-align:center;cursor:pointer}
    .stat.active{border-color:var(--purple);background:#f5f3ff}
    .stat-num{font-size:18px;font-weight:700}
    .stat-num.urgent{color:var(--red)}.stat-num.important{color:var(--orange)}.stat-num.inwork{color:var(--blue)}.stat-num.today{color:var(--yellow)}
    .stat-label{font-size:9px;color:var(--text2);margin-top:2px}
    
    .filter-bar{padding:8px 16px;display:none}
    .filter-bar.show{display:block}
    .filter-tag{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;background:var(--purple);color:#fff;border-radius:16px;font-size:12px}
    .filter-tag button{background:none;border:none;color:#fff;cursor:pointer}
    
    .input-bar{padding:12px 16px;display:flex;gap:8px;background:#fff;border-bottom:1px solid var(--border)}
    .voice-btn{width:44px;height:44px;border:none;border-radius:10px;background:var(--purple);color:#fff;font-size:18px;cursor:pointer}
    .voice-btn.on{animation:pulse 1s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
    .input-text{flex:1;border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:15px;outline:none}
    .input-text:focus{border-color:var(--purple)}
    .add-btn{width:44px;height:44px;border:none;border-radius:10px;background:var(--purple);color:#fff;font-size:20px;cursor:pointer}
    
    .loading{padding:8px 16px;display:none;align-items:center;gap:6px;font-size:13px;color:var(--purple)}
    .loading.show{display:flex}
    .loading::before{content:'';width:14px;height:14px;border:2px solid var(--border);border-top-color:var(--purple);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    .tasks{flex:1;padding:12px 16px 100px;overflow-y:auto}
    .section-title{font-size:13px;color:var(--text2);margin-bottom:10px;display:flex;align-items:center;gap:6px}
    
    .task{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:8px;cursor:pointer}
    .task:active{background:#f8fafc}
    .task-row{display:flex;gap:10px;align-items:flex-start}
    .task-check{width:20px;height:20px;border:2px solid var(--border);border-radius:5px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:12px;color:#fff}
    .task.done .task-check{background:var(--green);border-color:var(--green)}
    .task.done .task-check::after{content:'‚úì'}
    .task-info{flex:1}
    .task-title{font-size:14px;font-weight:500}
    .task.done .task-title{text-decoration:line-through;color:var(--text2)}
    .task-tags{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap}
    .tag{padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600}
    .tag.urgent{background:#fef2f2;color:var(--red)}
    .tag.important{background:#fff7ed;color:var(--orange)}
    .tag.inwork{background:#eff6ff;color:var(--blue)}
    .tag.later{background:#f0fdf4;color:var(--green)}
    .tag.date{background:#f8fafc;color:var(--text2)}
    .tag.overdue{background:#fef2f2;color:var(--red)}
    
    .done-section{margin-top:20px;padding-top:16px;border-top:1px solid var(--border)}
    .done-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .done-title{font-size:13px;color:var(--text2)}
    .clear-btn{font-size:12px;color:var(--red);background:none;border:none;cursor:pointer}
    
    .empty{text-align:center;padding:40px;color:var(--text2)}
    .empty-icon{font-size:36px;margin-bottom:8px}
    
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:200;display:none;align-items:flex-end}
    .modal.open{display:flex}
    .modal-box{background:#fff;width:100%;max-width:500px;margin:0 auto;border-radius:16px 16px 0 0;max-height:80vh;overflow-y:auto}
    .modal-head{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;font-weight:600}
    .modal-close{width:28px;height:28px;border:none;background:#f1f5f9;border-radius:6px;font-size:16px;cursor:pointer}
    .modal-body{padding:16px}
    .field{margin-bottom:14px}
    .field-label{font-size:12px;color:var(--text2);margin-bottom:4px}
    .field-input{width:100%;border:1px solid var(--border);border-radius:8px;padding:10px;font-size:14px;outline:none}
    .field-input:focus{border-color:var(--purple)}
    .prio-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
    .prio-btn{padding:8px;border:2px solid var(--border);border-radius:8px;font-size:12px;cursor:pointer;background:#fff}
    .prio-btn.active.urgent{border-color:var(--red);background:#fef2f2;color:var(--red)}
    .prio-btn.active.important{border-color:var(--orange);background:#fff7ed;color:var(--orange)}
    .prio-btn.active.inwork{border-color:var(--blue);background:#eff6ff;color:var(--blue)}
    .prio-btn.active.later{border-color:var(--green);background:#f0fdf4;color:var(--green)}
    .modal-btns{display:flex;gap:8px;margin-top:16px}
    .btn{flex:1;padding:12px;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer}
    .btn-del{background:#fef2f2;color:var(--red)}
    .btn-save{background:var(--purple);color:#fff}
    
    .chat{position:fixed;inset:0;background:#fff;z-index:200;display:flex;flex-direction:column;transform:translateX(100%);transition:transform 0.3s}
    .chat.open{transform:translateX(0)}
    .chat-head{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
    .chat-back{width:32px;height:32px;border:none;background:#f1f5f9;border-radius:8px;font-size:14px;cursor:pointer}
    .chat-msgs{flex:1;padding:16px;overflow-y:auto;background:#f8fafc;display:flex;flex-direction:column;gap:8px}
    .chat-suggest{display:flex;flex-direction:column;gap:6px}
    .suggest-btn{padding:10px 12px;background:#fff;border:1px solid var(--border);border-radius:10px;font-size:13px;text-align:left;cursor:pointer}
    .suggest-btn:active{background:#f8fafc}
    .msg{max-width:80%;padding:10px 12px;border-radius:12px;font-size:14px;line-height:1.4}
    .msg.user{align-self:flex-end;background:var(--purple);color:#fff}
    .msg.bot{align-self:flex-start;background:#fff;border:1px solid var(--border)}
    .msg.typing{color:var(--text2);font-style:italic}
    .chat-input{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px}
    .chat-text{flex:1;border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px;outline:none}
    .chat-send{width:40px;height:40px;border:none;border-radius:10px;background:var(--purple);color:#fff;font-size:16px;cursor:pointer}
    
    .nav{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid var(--border);display:flex;padding:8px 16px;padding-bottom:max(8px,env(safe-area-inset-bottom))}
    .nav-btn{flex:1;padding:6px;border:none;background:none;border-radius:8px;font-size:10px;color:var(--text2);cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:2px}
    .nav-btn.active{color:var(--purple);background:#f5f3ff}
    .nav-icon{font-size:18px}
    
    .toast{position:fixed;bottom:70px;left:50%;transform:translateX(-50%);background:var(--text);color:#fff;padding:10px 16px;border-radius:8px;font-size:13px;z-index:300}
    
    .debug{position:fixed;top:60px;left:10px;right:10px;background:#fee;border:1px solid #f00;padding:8px;font-size:11px;z-index:999;display:none;max-height:150px;overflow:auto}
    .debug.show{display:block}
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo"><div class="logo-icon">‚ö°</div>TaskAI</div>
    <button class="header-btn" onclick="openChat()">üí¨</button>
  </header>
  
  <div class="stats">
    <div class="stat" onclick="setFilter('urgent')"><div class="stat-num urgent" id="cntUrgent">0</div><div class="stat-label">–°—Ä–æ—á–Ω–æ</div></div>
    <div class="stat" onclick="setFilter('important')"><div class="stat-num important" id="cntImportant">0</div><div class="stat-label">–í–∞–∂–Ω–æ</div></div>
    <div class="stat" onclick="setFilter('inwork')"><div class="stat-num inwork" id="cntInwork">0</div><div class="stat-label">–í —Ä–∞–±–æ—Ç–µ</div></div>
    <div class="stat" onclick="setFilter('today')"><div class="stat-num today" id="cntToday">0</div><div class="stat-label">–°–µ–≥–æ–¥–Ω—è</div></div>
  </div>
  
  <div class="filter-bar" id="filterBar"><div class="filter-tag"><span id="filterName">–§–∏–ª—å—Ç—Ä</span><button onclick="clearFilter()">‚úï</button></div></div>
  
  <div class="input-bar">
    <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()">üé§</button>
    <input class="input-text" id="inputText" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É...">
    <button class="add-btn" onclick="addTask()">+</button>
  </div>
  
  <div class="loading" id="loading">–û–±—Ä–∞–±–æ—Ç–∫–∞...</div>
  
  <div class="tasks" id="tasksContainer"></div>
</div>

<div class="modal" id="editModal" onclick="if(event.target===this)closeEdit()">
  <div class="modal-box">
    <div class="modal-head"><span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span><button class="modal-close" onclick="closeEdit()">√ó</button></div>
    <div class="modal-body">
      <div class="field"><div class="field-label">–ù–∞–∑–≤–∞–Ω–∏–µ</div><input class="field-input" id="editTitle"></div>
      <div class="field"><div class="field-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</div>
        <div class="prio-grid">
          <button class="prio-btn urgent" onclick="setEditPrio('urgent')">üî¥ –°—Ä–æ—á–Ω–æ</button>
          <button class="prio-btn important" onclick="setEditPrio('important')">üü† –í–∞–∂–Ω–æ</button>
          <button class="prio-btn inwork" onclick="setEditPrio('inwork')">üîµ –í —Ä–∞–±–æ—Ç–µ</button>
          <button class="prio-btn later" onclick="setEditPrio('later')">üü¢ –ü–æ–∑–∂–µ</button>
        </div>
      </div>
      <div class="field"><div class="field-label">–î–∞—Ç–∞</div><input type="date" class="field-input" id="editDate"></div>
      <div class="modal-btns">
        <button class="btn btn-del" onclick="delTask()">–£–¥–∞–ª–∏—Ç—å</button>
        <button class="btn btn-save" onclick="saveEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<div class="chat" id="chatPanel">
  <div class="chat-head">
    <button class="chat-back" onclick="closeChat()">‚Üê</button>
    <span style="font-weight:600">AI –ü–æ–º–æ—â–Ω–∏–∫</span>
  </div>
  <div class="chat-msgs" id="chatMsgs">
    <div class="chat-suggest" id="chatSuggest">
      <button class="suggest-btn" onclick="askAI('–° —á–µ–≥–æ –Ω–∞—á–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è?')">üéØ –° —á–µ–≥–æ –Ω–∞—á–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è?</button>
      <button class="suggest-btn" onclick="askAI('–ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ —Å—Ä–æ—á–Ω—ã–µ?')">‚ö†Ô∏è –ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ —Å—Ä–æ—á–Ω—ã–µ?</button>
      <button class="suggest-btn" onclick="askAI('–°–ø–ª–∞–Ω–∏—Ä—É–π –º–æ–π –¥–µ–Ω—å')">üìÖ –°–ø–ª–∞–Ω–∏—Ä—É–π –º–æ–π –¥–µ–Ω—å</button>
    </div>
  </div>
  <div class="chat-input">
    <input class="chat-text" id="chatText" placeholder="–°–ø—Ä–æ—Å–∏—Ç–µ...">
    <button class="chat-send" onclick="sendChatMsg()">‚Üí</button>
  </div>
</div>

<nav class="nav">
  <button class="nav-btn active" id="navTasks" onclick="showTasks()"><span class="nav-icon">üìã</span>–ó–∞–¥–∞—á–∏</button>
  <button class="nav-btn" id="navAI" onclick="openChat()"><span class="nav-icon">ü§ñ</span>AI</button>
</nav>

<div class="debug" id="debug"></div>

<script>
const API = '/api/chat';
let tasks = JSON.parse(localStorage.getItem('tasks5') || '[]');
let filter = null;
let editId = null;
let editPrio = 'inwork';
let chatMsgs = [];
let listening = false;
let recog = null;

// Debug
function dbg(msg) {
  console.log(msg);
  const d = document.getElementById('debug');
  d.innerHTML = msg + '<br>' + d.innerHTML;
  d.classList.add('show');
  setTimeout(() => d.classList.remove('show'), 5000);
}

// Init
render();
updateCounts();
setupVoice();

document.getElementById('inputText').addEventListener('keypress', e => {
  if (e.key === 'Enter') addTask();
});
document.getElementById('chatText').addEventListener('keypress', e => {
  if (e.key === 'Enter') sendChatMsg();
});

function setupVoice() {
  if ('webkitSpeechRecognition' in window) {
    recog = new webkitSpeechRecognition();
    recog.lang = 'ru-RU';
    recog.continuous = false;
    recog.onresult = e => {
      const t = e.results[0][0].transcript;
      document.getElementById('inputText').value = t;
      stopVoice();
    };
    recog.onerror = () => stopVoice();
    recog.onend = () => stopVoice();
  }
}

function toggleVoice() {
  if (!recog) { toast('–ì–æ–ª–æ—Å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'); return; }
  listening ? stopVoice() : startVoice();
}

function startVoice() {
  listening = true;
  document.getElementById('voiceBtn').classList.add('on');
  recog.start();
}

function stopVoice() {
  listening = false;
  document.getElementById('voiceBtn').classList.remove('on');
  try { recog.stop(); } catch(e) {}
}

async function addTask() {
  const inp = document.getElementById('inputText');
  const text = inp.value.trim();
  if (!text) return;
  inp.value = '';
  
  document.getElementById('loading').classList.add('show');
  
  try {
    dbg('–û—Ç–ø—Ä–∞–≤–ª—è—é: ' + text);
    const res = await fetch(API, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mode: 'parse', messages: [{ role: 'user', content: text }] })
    });
    
    const data = await res.json();
    dbg('–û—Ç–≤–µ—Ç: ' + JSON.stringify(data));
    
    if (data.error) {
      dbg('–û—à–∏–±–∫–∞ API: ' + data.error);
      addSimple(text);
      return;
    }
    
    let parsed = [];
    try {
      const m = data.content.match(/\[[\s\S]*?\]/);
      if (m) parsed = JSON.parse(m[0]);
    } catch(e) { dbg('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ' + e.message); }
    
    if (parsed.length) {
      parsed.forEach(t => {
        tasks.unshift({
          id: Date.now() + Math.random(),
          title: t.title || text,
          prio: mapPrio(t.priority),
          date: t.deadline || null,
          done: false
        });
      });
      save();
      toast('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: ' + parsed.length);
    } else {
      addSimple(text);
    }
  } catch(e) {
    dbg('Fetch –æ—à–∏–±–∫–∞: ' + e.message);
    addSimple(text);
  }
  
  document.getElementById('loading').classList.remove('show');
  render();
  updateCounts();
}

function mapPrio(p) {
  if (p === 'urgent') return 'urgent';
  if (p === 'high' || p === 'important') return 'important';
  if (p === 'low' || p === 'later') return 'later';
  return 'inwork';
}

function addSimple(text) {
  tasks.unshift({ id: Date.now(), title: text, prio: 'inwork', date: null, done: false });
  save();
  toast('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ');
}

function save() {
  localStorage.setItem('tasks5', JSON.stringify(tasks));
}

function setFilter(f) {
  filter = f;
  document.querySelectorAll('.stat').forEach(s => s.classList.remove('active'));
  event.currentTarget.classList.add('active');
  const names = { urgent: 'üî¥ –°—Ä–æ—á–Ω—ã–µ', important: 'üü† –í–∞–∂–Ω—ã–µ', inwork: 'üîµ –í —Ä–∞–±–æ—Ç–µ', today: 'üìÖ –°–µ–≥–æ–¥–Ω—è' };
  document.getElementById('filterName').textContent = names[f];
  document.getElementById('filterBar').classList.add('show');
  render();
}

function clearFilter() {
  filter = null;
  document.querySelectorAll('.stat').forEach(s => s.classList.remove('active'));
  document.getElementById('filterBar').classList.remove('show');
  render();
}

function render() {
  const cont = document.getElementById('tasksContainer');
  const today = new Date(); today.setHours(0,0,0,0);
  const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);
  
  let active = tasks.filter(t => !t.done);
  let done = tasks.filter(t => t.done);
  
  if (filter === 'urgent') active = active.filter(t => t.prio === 'urgent');
  else if (filter === 'important') active = active.filter(t => t.prio === 'important');
  else if (filter === 'inwork') active = active.filter(t => t.prio === 'inwork');
  else if (filter === 'today') active = active.filter(t => {
    if (!t.date) return false;
    const d = new Date(t.date);
    return d >= today && d < tomorrow;
  });
  
  const prioOrder = { urgent: 0, important: 1, inwork: 2, later: 3 };
  active.sort((a, b) => prioOrder[a.prio] - prioOrder[b.prio]);
  
  const prioNames = { urgent: 'üî¥ –°—Ä–æ—á–Ω–æ', important: 'üü† –í–∞–∂–Ω–æ', inwork: 'üîµ –í —Ä–∞–±–æ—Ç–µ', later: 'üü¢ –ü–æ–∑–∂–µ' };
  
  let html = '';
  
  if (active.length === 0) {
    html = '<div class="empty"><div class="empty-icon">üìù</div>–ù–µ—Ç –∑–∞–¥–∞—á</div>';
  } else {
    html = '<div class="section-title">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏</div>';
    active.forEach(t => {
      const dateTag = t.date ? `<span class="tag date ${isOverdue(t.date) ? 'overdue' : ''}">${formatDate(t.date)}</span>` : '';
      html += `<div class="task" onclick="openEdit(${t.id})">
        <div class="task-row">
          <div class="task-check" onclick="event.stopPropagation();toggleDone(${t.id})"></div>
          <div class="task-info">
            <div class="task-title">${esc(t.title)}</div>
            <div class="task-tags"><span class="tag ${t.prio}">${prioNames[t.prio]}</span>${dateTag}</div>
          </div>
        </div>
      </div>`;
    });
  }
  
  if (done.length && !filter) {
    html += `<div class="done-section">
      <div class="done-header">
        <span class="done-title">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ (${done.length})</span>
        <button class="clear-btn" onclick="clearDone()">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>`;
    done.slice(0, 3).forEach(t => {
      html += `<div class="task done" onclick="openEdit(${t.id})">
        <div class="task-row">
          <div class="task-check" onclick="event.stopPropagation();toggleDone(${t.id})"></div>
          <div class="task-info"><div class="task-title">${esc(t.title)}</div></div>
        </div>
      </div>`;
    });
    html += '</div>';
  }
  
  cont.innerHTML = html;
}

function formatDate(d) {
  const date = new Date(d);
  const today = new Date(); today.setHours(0,0,0,0);
  const diff = Math.round((date - today) / 86400000);
  if (diff < 0) return '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ';
  if (diff === 0) return '–°–µ–≥–æ–¥–Ω—è';
  if (diff === 1) return '–ó–∞–≤—Ç—Ä–∞';
  return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
}

function isOverdue(d) {
  return new Date(d) < new Date().setHours(0,0,0,0);
}

function toggleDone(id) {
  const t = tasks.find(x => x.id === id);
  if (t) { t.done = !t.done; save(); render(); updateCounts(); }
}

function updateCounts() {
  const active = tasks.filter(t => !t.done);
  const today = new Date(); today.setHours(0,0,0,0);
  const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);
  
  document.getElementById('cntUrgent').textContent = active.filter(t => t.prio === 'urgent').length;
  document.getElementById('cntImportant').textContent = active.filter(t => t.prio === 'important').length;
  document.getElementById('cntInwork').textContent = active.filter(t => t.prio === 'inwork').length;
  document.getElementById('cntToday').textContent = active.filter(t => t.date && new Date(t.date) >= today && new Date(t.date) < tomorrow).length;
}

function clearDone() {
  tasks = tasks.filter(t => !t.done);
  save(); render(); updateCounts();
  toast('üóë –û—á–∏—â–µ–Ω–æ');
}

function openEdit(id) {
  const t = tasks.find(x => x.id === id);
  if (!t) return;
  editId = id;
  editPrio = t.prio;
  document.getElementById('editTitle').value = t.title;
  document.getElementById('editDate').value = t.date || '';
  document.querySelectorAll('.prio-btn').forEach(b => b.classList.toggle('active', b.classList.contains(t.prio)));
  document.getElementById('editModal').classList.add('open');
}

function closeEdit() {
  document.getElementById('editModal').classList.remove('open');
  editId = null;
}

function setEditPrio(p) {
  editPrio = p;
  document.querySelectorAll('.prio-btn').forEach(b => b.classList.toggle('active', b.classList.contains(p)));
}

function saveEdit() {
  const t = tasks.find(x => x.id === editId);
  if (!t) return;
  t.title = document.getElementById('editTitle').value.trim() || t.title;
  t.prio = editPrio;
  t.date = document.getElementById('editDate').value || null;
  save(); render(); updateCounts(); closeEdit();
  toast('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
}

function delTask() {
  tasks = tasks.filter(t => t.id !== editId);
  save(); render(); updateCounts(); closeEdit();
  toast('üóë –£–¥–∞–ª–µ–Ω–æ');
}

// Chat
function openChat() {
  document.getElementById('chatPanel').classList.add('open');
  document.getElementById('navAI').classList.add('active');
  document.getElementById('navTasks').classList.remove('active');
}

function closeChat() {
  document.getElementById('chatPanel').classList.remove('open');
  document.getElementById('navTasks').classList.add('active');
  document.getElementById('navAI').classList.remove('active');
}

function showTasks() {
  closeChat();
}

function askAI(q) {
  document.getElementById('chatText').value = q;
  sendChatMsg();
}

async function sendChatMsg() {
  const inp = document.getElementById('chatText');
  const text = inp.value.trim();
  if (!text) return;
  inp.value = '';
  
  chatMsgs.push({ role: 'user', text });
  renderChat();
  document.getElementById('chatSuggest').style.display = 'none';
  
  // Add typing indicator
  const msgsDiv = document.getElementById('chatMsgs');
  const typingDiv = document.createElement('div');
  typingDiv.className = 'msg bot typing';
  typingDiv.id = 'typing';
  typingDiv.textContent = 'AI –¥—É–º–∞–µ—Ç...';
  msgsDiv.appendChild(typingDiv);
  msgsDiv.scrollTop = msgsDiv.scrollHeight;
  
  const taskList = tasks.map(t => {
    const st = t.done ? '‚úÖ' : '‚¨ú';
    const pr = { urgent: '–°–†–û–ß–ù–û', important: '–í–ê–ñ–ù–û', inwork: '–≤ —Ä–∞–±–æ—Ç–µ', later: '–ø–æ–∑–∂–µ' }[t.prio];
    const dt = t.date ? ' –¥–æ ' + t.date : '';
    return `${st} [${pr}] ${t.title}${dt}`;
  }).join('\n');
  
  const sysPrompt = `–¢—ã AI-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∞–º–∏. –°–µ–≥–æ–¥–Ω—è: ${new Date().toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long' })}.

–ó–∞–¥–∞—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
${taskList || '–ù–µ—Ç –∑–∞–¥–∞—á'}

–ü–æ–º–æ–≥–∞–π –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å, –¥–∞–≤–∞–π —Å–æ–≤–µ—Ç—ã –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –Ω–∞ —Ä—É—Å—Å–∫–æ–º, —Å —ç–º–æ–¥–∑–∏.`;
  
  try {
    dbg('Chat –∑–∞–ø—Ä–æ—Å...');
    const res = await fetch(API, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        system: sysPrompt,
        messages: chatMsgs.map(m => ({ role: m.role === 'user' ? 'user' : 'assistant', content: m.text }))
      })
    });
    
    const data = await res.json();
    dbg('Chat –æ—Ç–≤–µ—Ç: ' + JSON.stringify(data).substring(0, 200));
    
    document.getElementById('typing')?.remove();
    
    if (data.error) {
      chatMsgs.push({ role: 'bot', text: '‚ùå –û—à–∏–±–∫–∞: ' + data.error });
    } else if (data.content) {
      chatMsgs.push({ role: 'bot', text: data.content });
    } else {
      chatMsgs.push({ role: 'bot', text: '‚ùå –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç' });
    }
  } catch(e) {
    dbg('Chat fetch –æ—à–∏–±–∫–∞: ' + e.message);
    document.getElementById('typing')?.remove();
    chatMsgs.push({ role: 'bot', text: '‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏: ' + e.message });
  }
  
  renderChat();
}

function renderChat() {
  const div = document.getElementById('chatMsgs');
  div.innerHTML = chatMsgs.map(m => `<div class="msg ${m.role === 'user' ? 'user' : 'bot'}">${esc(m.text)}</div>`).join('');
  div.scrollTop = div.scrollHeight;
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function toast(msg) {
  const t = document.createElement('div');
  t.className = 'toast';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 2000);
}
</script>
</body>
</html>
