<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#f8fafc">
  <title>TaskAI</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--bg:#f8fafc;--surface:#ffffff;--elevated:#f1f5f9;--border:#e2e8f0;--text:#1e293b;--text2:#64748b;--purple:#7c3aed;--blue:#3b82f6;--red:#dc2626;--orange:#ea580c;--yellow:#ca8a04;--green:#16a34a}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;min-height:100dvh}
    .app{max-width:500px;margin:0 auto;min-height:100vh;min-height:100dvh;display:flex;flex-direction:column;background:var(--bg)}
    
    header{padding:16px 20px;display:flex;align-items:center;justify-content:space-between;background:var(--surface);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
    .logo{display:flex;align-items:center;gap:10px;font-weight:700;font-size:20px;color:var(--purple)}
    .logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--purple),var(--blue));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;color:white}
    .header-btn{width:40px;height:40px;border:1px solid var(--border);background:var(--surface);border-radius:10px;color:var(--text2);font-size:18px;cursor:pointer}
    .header-btn:hover{background:var(--elevated)}
    
    .stats{padding:12px 16px;display:flex;gap:8px;overflow-x:auto;background:var(--surface);border-bottom:1px solid var(--border)}
    .stats::-webkit-scrollbar{display:none}
    .stat{flex-shrink:0;background:var(--elevated);border:2px solid transparent;border-radius:12px;padding:10px 14px;text-align:center;cursor:pointer;transition:all 0.2s;min-width:70px}
    .stat:hover{border-color:var(--purple)}
    .stat.active{border-color:var(--purple);background:rgba(124,58,237,0.1)}
    .stat-num{font-size:20px;font-weight:700}
    .stat-num.urgent{color:var(--red)}
    .stat-num.important{color:var(--orange)}
    .stat-num.inwork{color:var(--blue)}
    .stat-num.today{color:var(--yellow)}
    .stat-label{font-size:10px;color:var(--text2);margin-top:2px}
    
    .active-filter{padding:8px 20px;display:none;background:var(--surface)}
    .active-filter.show{display:block}
    .filter-tag{display:inline-flex;align-items:center;gap:8px;padding:6px 12px;background:var(--purple);color:white;border-radius:20px;font-size:13px}
    .filter-tag button{background:none;border:none;color:white;font-size:14px;cursor:pointer;padding:0}
    
    .input-section{padding:12px 16px;display:flex;gap:8px;background:var(--surface);border-bottom:1px solid var(--border)}
    .voice-btn{width:46px;height:46px;border-radius:12px;border:none;background:var(--purple);color:white;font-size:20px;cursor:pointer;flex-shrink:0}
    .voice-btn.listening{animation:pulse 1.5s infinite}
    @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(124,58,237,0.4)}50%{box-shadow:0 0 0 10px rgba(124,58,237,0)}}
    .text-input{flex:1;background:var(--elevated);border:1px solid var(--border);border-radius:12px;padding:12px 14px;color:var(--text);font-size:15px;outline:none}
    .text-input:focus{border-color:var(--purple);background:var(--surface)}
    .text-input::placeholder{color:var(--text2)}
    .send-btn{width:46px;height:46px;background:var(--purple);border:none;border-radius:12px;color:white;font-size:18px;cursor:pointer;flex-shrink:0}
    
    .processing{padding:8px 20px;color:var(--purple);font-size:13px;display:none;align-items:center;gap:8px;background:var(--surface)}
    .processing.show{display:flex}
    .spinner{width:14px;height:14px;border:2px solid var(--border);border-top-color:var(--purple);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    .tasks-section{flex:1;padding:12px 16px 120px;overflow-y:auto}
    .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .section-title{font-size:16px;font-weight:600;color:var(--text2)}
    .clear-done{font-size:13px;color:var(--text2);background:none;border:none;cursor:pointer}
    .clear-done:hover{color:var(--red)}
    
    .task-list{display:flex;flex-direction:column;gap:8px}
    .task{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:14px;cursor:pointer;transition:all 0.2s;box-shadow:0 1px 2px rgba(0,0,0,0.04)}
    .task:hover{border-color:var(--purple);box-shadow:0 2px 8px rgba(124,58,237,0.1)}
    .task.done{opacity:0.6;background:var(--elevated)}
    .task-header{display:flex;gap:12px;align-items:flex-start}
    .checkbox{width:22px;height:22px;border:2px solid var(--border);border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.2s}
    .checkbox:hover{border-color:var(--green)}
    .task.done .checkbox{background:var(--green);border-color:var(--green)}
    .checkbox::after{content:'‚úì';color:white;font-size:12px;font-weight:700;opacity:0}
    .task.done .checkbox::after{opacity:1}
    .task-content{flex:1;min-width:0}
    .task-title{font-size:15px;font-weight:500;line-height:1.4;color:var(--text)}
    .task.done .task-title{text-decoration:line-through;color:var(--text2)}
    .task-meta{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .badge{padding:3px 8px;border-radius:6px;font-size:11px;font-weight:600}
    .badge.urgent{background:#fef2f2;color:var(--red)}
    .badge.important{background:#fff7ed;color:var(--orange)}
    .badge.inwork{background:#eff6ff;color:var(--blue)}
    .badge.later{background:#f0fdf4;color:var(--green)}
    .badge.deadline{background:var(--elevated);color:var(--text2)}
    .badge.overdue{background:#fef2f2;color:var(--red)}
    
    .done-section{margin-top:24px;padding-top:16px;border-top:1px solid var(--border)}
    .done-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .done-title{font-size:14px;color:var(--text2);display:flex;align-items:center;gap:6px}
    .done-count{background:var(--elevated);padding:2px 8px;border-radius:10px;font-size:12px}
    
    .empty{text-align:center;padding:40px 20px;color:var(--text2)}
    .empty-icon{font-size:40px;margin-bottom:12px;opacity:0.5}
    .empty-title{font-size:15px;margin-bottom:6px;color:var(--text)}
    
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.3);z-index:200;display:none;align-items:flex-end;justify-content:center}
    .modal-overlay.open{display:flex}
    .modal{background:var(--surface);border-radius:20px 20px 0 0;width:100%;max-width:500px;max-height:85vh;overflow-y:auto;animation:slideUp 0.3s}
    @keyframes slideUp{from{transform:translateY(100%)}}
    .modal-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:var(--surface)}
    .modal-title{font-size:17px;font-weight:600}
    .modal-close{width:32px;height:32px;border:none;background:var(--elevated);border-radius:8px;color:var(--text);font-size:18px;cursor:pointer}
    .modal-body{padding:16px 20px}
    
    .form-group{margin-bottom:16px}
    .form-label{font-size:13px;color:var(--text2);margin-bottom:6px;display:block}
    .form-input{width:100%;background:var(--elevated);border:1px solid var(--border);border-radius:10px;padding:12px 14px;color:var(--text);font-size:15px;outline:none}
    .form-input:focus{border-color:var(--purple);background:var(--surface)}
    .form-textarea{min-height:80px;resize:vertical;font-family:inherit}
    
    .priority-selector{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .priority-btn{padding:10px;border:2px solid var(--border);background:var(--surface);border-radius:10px;color:var(--text2);font-size:13px;cursor:pointer;text-align:center;transition:all 0.2s}
    .priority-btn.active.urgent{border-color:var(--red);background:#fef2f2;color:var(--red)}
    .priority-btn.active.important{border-color:var(--orange);background:#fff7ed;color:var(--orange)}
    .priority-btn.active.inwork{border-color:var(--blue);background:#eff6ff;color:var(--blue)}
    .priority-btn.active.later{border-color:var(--green);background:#f0fdf4;color:var(--green)}
    
    .modal-actions{display:flex;gap:10px;margin-top:20px}
    .btn{flex:1;padding:14px;border:none;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer}
    .btn-primary{background:var(--purple);color:white}
    .btn-danger{background:#fef2f2;color:var(--red)}
    
    .chat-modal{position:fixed;inset:0;background:var(--bg);z-index:200;display:flex;flex-direction:column;transform:translateX(100%);transition:transform 0.3s}
    .chat-modal.open{transform:translateX(0)}
    .chat-header{padding:16px 20px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border);background:var(--surface)}
    .back-btn{width:36px;height:36px;background:var(--elevated);border:none;border-radius:10px;color:var(--text);font-size:16px;cursor:pointer}
    .chat-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px;background:var(--bg)}
    .suggestions{display:flex;flex-direction:column;gap:8px}
    .suggestion{padding:12px 14px;background:var(--surface);border:1px solid var(--border);border-radius:12px;font-size:14px;color:var(--text2);cursor:pointer;text-align:left}
    .suggestion:hover{border-color:var(--purple);color:var(--text)}
    .chat-msg{max-width:85%}
    .chat-msg.user{align-self:flex-end}
    .chat-msg.assistant{align-self:flex-start}
    .bubble{padding:12px 16px;border-radius:16px;font-size:14px;line-height:1.5;white-space:pre-wrap}
    .chat-msg.user .bubble{background:var(--purple);color:white;border-bottom-right-radius:4px}
    .chat-msg.assistant .bubble{background:var(--surface);border:1px solid var(--border);border-bottom-left-radius:4px}
    .chat-typing{padding:12px 16px;background:var(--surface);border:1px solid var(--border);border-radius:16px;color:var(--text2);font-size:13px}
    .chat-input-area{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;background:var(--surface)}
    .chat-input{flex:1;background:var(--elevated);border:1px solid var(--border);border-radius:12px;padding:12px 14px;color:var(--text);font-size:15px;outline:none}
    .chat-send{width:44px;height:44px;background:var(--purple);border:none;border-radius:12px;color:white;font-size:18px;cursor:pointer}
    
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid var(--border);display:flex;justify-content:center;padding:8px 20px;padding-bottom:max(8px,env(safe-area-inset-bottom))}
    .nav-btn{flex:1;max-width:120px;padding:8px;background:none;border:none;border-radius:10px;color:var(--text2);font-size:11px;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px}
    .nav-btn.active{color:var(--purple);background:rgba(124,58,237,0.1)}
    .nav-icon{font-size:20px}
    
    .toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:var(--text);color:white;padding:12px 20px;border-radius:12px;font-size:14px;z-index:300}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo"><div class="logo-icon">‚ö°</div>TaskAI</div>
      <button class="header-btn" onclick="openChat()">üí¨</button>
    </header>
    
    <div class="stats">
      <div class="stat" id="statUrgent" onclick="filterBy('urgent')">
        <div class="stat-num urgent" id="urgentCount">0</div>
        <div class="stat-label">–°—Ä–æ—á–Ω–æ</div>
      </div>
      <div class="stat" id="statImportant" onclick="filterBy('important')">
        <div class="stat-num important" id="importantCount">0</div>
        <div class="stat-label">–í–∞–∂–Ω–æ</div>
      </div>
      <div class="stat" id="statInwork" onclick="filterBy('inwork')">
        <div class="stat-num inwork" id="inworkCount">0</div>
        <div class="stat-label">–í —Ä–∞–±–æ—Ç–µ</div>
      </div>
      <div class="stat" id="statToday" onclick="filterBy('today')">
        <div class="stat-num today" id="todayCount">0</div>
        <div class="stat-label">–°–µ–≥–æ–¥–Ω—è</div>
      </div>
    </div>
    
    <div class="active-filter" id="activeFilter">
      <div class="filter-tag">
        <span id="filterLabel">–§–∏–ª—å—Ç—Ä</span>
        <button onclick="clearFilter()">‚úï</button>
      </div>
    </div>
    
    <div class="input-section">
      <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()">üé§</button>
      <input type="text" class="text-input" id="textInput" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É..." onkeypress="if(event.key==='Enter')sendText()">
      <button class="send-btn" onclick="sendText()">+</button>
    </div>
    
    <div class="processing" id="processing"><div class="spinner"></div><span>AI –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç...</span></div>
    
    <div class="tasks-section">
      <div class="section-header">
        <span class="section-title" id="sectionTitle">–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏</span>
      </div>
      <div class="task-list" id="taskList"></div>
      
      <div class="done-section" id="doneSection" style="display:none">
        <div class="done-header">
          <span class="done-title">‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ <span class="done-count" id="doneCount">0</span></span>
          <button class="clear-done" onclick="clearDone()">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
        <div class="task-list" id="doneList"></div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
        <button class="modal-close" onclick="closeEditModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input type="text" class="form-input" id="editTitle">
        </div>
        <div class="form-group">
          <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea class="form-input form-textarea" id="editDesc" placeholder="–î–æ–±–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
          <div class="priority-selector">
            <button class="priority-btn urgent" data-p="urgent" onclick="setPriority('urgent')">üî¥ –°—Ä–æ—á–Ω–æ</button>
            <button class="priority-btn important" data-p="important" onclick="setPriority('important')">üü† –í–∞–∂–Ω–æ</button>
            <button class="priority-btn inwork" data-p="inwork" onclick="setPriority('inwork')">üîµ –í —Ä–∞–±–æ—Ç–µ</button>
            <button class="priority-btn later" data-p="later" onclick="setPriority('later')">üü¢ –ü–æ–∑–∂–µ</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">–î–µ–¥–ª–∞–π–Ω</label>
          <input type="date" class="form-input" id="editDeadline">
        </div>
        <div class="modal-actions">
          <button class="btn btn-danger" onclick="deleteTask()">–£–¥–∞–ª–∏—Ç—å</button>
          <button class="btn btn-primary" onclick="saveTask()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <div class="chat-modal" id="chatModal">
    <div class="chat-header">
      <button class="back-btn" onclick="closeChat()">‚Üê</button>
      <span style="font-weight:600;font-size:17px">AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</span>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="suggestions" id="suggestions">
        <button class="suggestion" onclick="askQ(this)">üìä –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –º–æ–∏ –∑–∞–¥–∞—á–∏</button>
        <button class="suggestion" onclick="askQ(this)">üéØ –° —á–µ–≥–æ –Ω–∞—á–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è?</button>
        <button class="suggestion" onclick="askQ(this)">‚ö†Ô∏è –ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ –ø–æ–¥ —É–≥—Ä–æ–∑–æ–π?</button>
        <button class="suggestion" onclick="askQ(this)">üìÖ –°–ø–ª–∞–Ω–∏—Ä—É–π –º–æ–π –¥–µ–Ω—å</button>
      </div>
    </div>
    <div class="chat-input-area">
      <input type="text" class="chat-input" id="chatInput" placeholder="–°–ø—Ä–æ—Å–∏..." onkeypress="if(event.key==='Enter')sendChat()">
      <button class="chat-send" onclick="sendChat()">‚Üí</button>
    </div>
  </div>

  <nav class="bottom-nav">
    <button class="nav-btn active" id="navTasks" onclick="goTasks()"><span class="nav-icon">üìã</span><span>–ó–∞–¥–∞—á–∏</span></button>
    <button class="nav-btn" id="navAI" onclick="openChat()"><span class="nav-icon">ü§ñ</span><span>AI</span></button>
  </nav>

  <script>
    const API='/api/chat';
    let tasks=JSON.parse(localStorage.getItem('taskai4')||'[]');
    let filterMode=null;
    let listening=false;
    let recognition=null;
    let chatHistory=[];
    let editingId=null;
    let editPriority='inwork';
    let isProcessing=false;

    init();

    function init(){
      renderTasks();
      updateStats();
      setupSpeech();
    }

    function setupSpeech(){
      if('webkitSpeechRecognition' in window||'SpeechRecognition' in window){
        const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
        recognition=new SR();
        recognition.continuous=false;
        recognition.interimResults=true;
        recognition.lang='ru-RU';
        recognition.onresult=e=>{
          let t='';
          for(let i=0;i<e.results.length;i++)t+=e.results[i][0].transcript;
          document.getElementById('textInput').value=t;
        };
        recognition.onerror=()=>stopVoice();
        recognition.onend=()=>{
          if(listening){
            const t=document.getElementById('textInput').value.trim();
            stopVoice();
            if(t)handleInput(t);
          }
        };
      }
    }

    function toggleVoice(){listening?recognition.stop():startVoice()}
    
    function startVoice(){
      listening=true;
      document.getElementById('voiceBtn').classList.add('listening');
      document.getElementById('textInput').value='';
      document.getElementById('textInput').placeholder='–ì–æ–≤–æ—Ä–∏—Ç–µ...';
      recognition.start();
    }
    
    function stopVoice(){
      listening=false;
      document.getElementById('voiceBtn').classList.remove('listening');
      document.getElementById('textInput').placeholder='–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É...';
    }

    function sendText(){
      const inp=document.getElementById('textInput');
      const t=inp.value.trim();
      if(t){inp.value='';handleInput(t);}
    }

    function handleInput(text){
      const lower=text.toLowerCase();
      if((lower.includes('–ø–æ–∫–∞–∂–∏')||lower.includes('–æ—Ç–∫—Ä–æ–π'))&&lower.includes('—Å—Ä–æ—á–Ω')){filterBy('urgent');return;}
      if((lower.includes('–ø–æ–∫–∞–∂–∏')||lower.includes('–æ—Ç–∫—Ä–æ–π'))&&lower.includes('–≤–∞–∂–Ω')){filterBy('important');return;}
      if((lower.includes('–ø–æ–∫–∞–∂–∏')||lower.includes('–æ—Ç–∫—Ä–æ–π'))&&(lower.includes('—Ä–∞–±–æ—Ç')||lower.includes('–≤ —Ä–∞–±–æ—Ç–µ'))){filterBy('inwork');return;}
      if((lower.includes('–ø–æ–∫–∞–∂–∏')||lower.includes('–æ—Ç–∫—Ä–æ–π')||lower.includes('—á—Ç–æ'))&&lower.includes('—Å–µ–≥–æ–¥–Ω')){filterBy('today');return;}
      if(lower.includes('–≤—Å–µ –∑–∞–¥–∞—á–∏')||lower==='–≤—Å–µ'){clearFilter();return;}
      processInput(text);
    }

    async function processInput(text){
      if(!text.trim()||isProcessing)return;
      isProcessing=true;
      document.getElementById('processing').classList.add('show');
      
      try{
        const res=await fetch(API,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({mode:'parse',messages:[{role:'user',content:text}]})
        });
        const data=await res.json();
        
        if(data.error){addTaskSimple(text);return;}
        
        let newTasks=[];
        try{
          const match=data.content.match(/\[[\s\S]*?\]/);
          if(match)newTasks=JSON.parse(match[0]);
        }catch(e){}
        
        if(newTasks&&newTasks.length){
          newTasks.forEach(t=>{
            let priority=t.priority||'inwork';
            if(priority==='high')priority='important';
            if(priority==='medium')priority='inwork';
            if(priority==='low')priority='later';
            tasks.unshift({
              id:Date.now()+Math.random(),
              title:t.title||text,
              description:t.description||'',
              priority:priority,
              deadline:t.deadline||null,
              status:'active',
              created:new Date().toISOString()
            });
          });
          save();renderTasks();updateStats();
          toast('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: '+newTasks.length);
        }else{addTaskSimple(text);}
      }catch(e){addTaskSimple(text);}
      
      isProcessing=false;
      document.getElementById('processing').classList.remove('show');
    }

    function addTaskSimple(text){
      tasks.unshift({id:Date.now(),title:text,description:'',priority:'inwork',deadline:null,status:'active',created:new Date().toISOString()});
      save();renderTasks();updateStats();toast('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ');
      document.getElementById('processing').classList.remove('show');
      isProcessing=false;
    }

    function save(){localStorage.setItem('taskai4',JSON.stringify(tasks))}

    function filterBy(type){
      filterMode=type;
      document.querySelectorAll('.stat').forEach(s=>s.classList.remove('active'));
      const el=document.getElementById('stat'+type.charAt(0).toUpperCase()+type.slice(1));
      if(el)el.classList.add('active');
      const labels={urgent:'üî¥ –°—Ä–æ—á–Ω—ã–µ',important:'üü† –í–∞–∂–Ω—ã–µ',inwork:'üîµ –í —Ä–∞–±–æ—Ç–µ',today:'üìÖ –ù–∞ —Å–µ–≥–æ–¥–Ω—è'};
      document.getElementById('filterLabel').textContent=labels[type]||type;
      document.getElementById('activeFilter').classList.add('show');
      document.getElementById('sectionTitle').textContent=labels[type]||'–ó–∞–¥–∞—á–∏';
      renderTasks();
    }

    function clearFilter(){
      filterMode=null;
      document.querySelectorAll('.stat').forEach(s=>s.classList.remove('active'));
      document.getElementById('activeFilter').classList.remove('show');
      document.getElementById('sectionTitle').textContent='–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏';
      renderTasks();
    }

    function renderTasks(){
      const list=document.getElementById('taskList');
      const doneList=document.getElementById('doneList');
      const doneSection=document.getElementById('doneSection');
      
      let active=tasks.filter(t=>t.status!=='done');
      let done=tasks.filter(t=>t.status==='done');
      
      const today=new Date();today.setHours(0,0,0,0);
      const tomorrow=new Date(today);tomorrow.setDate(tomorrow.getDate()+1);
      
      if(filterMode==='urgent')active=active.filter(t=>t.priority==='urgent');
      else if(filterMode==='important')active=active.filter(t=>t.priority==='important');
      else if(filterMode==='inwork')active=active.filter(t=>t.priority==='inwork');
      else if(filterMode==='today')active=active.filter(t=>t.deadline&&new Date(t.deadline)>=today&&new Date(t.deadline)<tomorrow);
      
      const prio={urgent:0,important:1,inwork:2,later:3};
      active.sort((a,b)=>{
        if(prio[a.priority]!==prio[b.priority])return prio[a.priority]-prio[b.priority];
        if(a.deadline&&b.deadline)return new Date(a.deadline)-new Date(b.deadline);
        if(a.deadline)return -1;
        return 0;
      });
      
      const prioLabels={urgent:'üî¥ –°—Ä–æ—á–Ω–æ',important:'üü† –í–∞–∂–Ω–æ',inwork:'üîµ –í —Ä–∞–±–æ—Ç–µ',later:'üü¢ –ü–æ–∑–∂–µ'};
      
      if(!active.length){
        list.innerHTML='<div class="empty"><div class="empty-icon">üìù</div><div class="empty-title">'+(filterMode?'–ù–µ—Ç –∑–∞–¥–∞—á':'–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á')+'</div><div>–î–æ–±–∞–≤—å—Ç–µ –∑–∞–¥–∞—á—É –≥–æ–ª–æ—Å–æ–º –∏–ª–∏ —Ç–µ–∫—Å—Ç–æ–º</div></div>';
      }else{
        list.innerHTML=active.map(t=>{
          const dl=deadlineInfo(t.deadline);
          return'<div class="task" onclick="openEdit('+t.id+')"><div class="task-header"><div class="checkbox" onclick="event.stopPropagation();toggle('+t.id+')"></div><div class="task-content"><div class="task-title">'+esc(t.title)+'</div><div class="task-meta"><span class="badge '+t.priority+'">'+(prioLabels[t.priority]||t.priority)+'</span>'+(t.deadline?'<span class="badge deadline '+dl.cls+'">üìÖ '+dl.text+'</span>':'')+'</div></div></div></div>';
        }).join('');
      }
      
      if(done.length&&!filterMode){
        doneSection.style.display='block';
        document.getElementById('doneCount').textContent=done.length;
        doneList.innerHTML=done.slice(0,5).map(t=>'<div class="task done" onclick="openEdit('+t.id+')"><div class="task-header"><div class="checkbox" onclick="event.stopPropagation();toggle('+t.id+')"></div><div class="task-content"><div class="task-title">'+esc(t.title)+'</div></div></div></div>').join('');
      }else{doneSection.style.display='none';}
    }

    function deadlineInfo(d){
      if(!d)return{text:'',cls:''};
      const date=new Date(d);const today=new Date();today.setHours(0,0,0,0);
      const diff=Math.ceil((date-today)/86400000);
      if(diff<0)return{text:'–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ',cls:'overdue'};
      if(diff===0)return{text:'–°–µ–≥–æ–¥–Ω—è',cls:'overdue'};
      if(diff===1)return{text:'–ó–∞–≤—Ç—Ä–∞',cls:''};
      if(diff<=7)return{text:diff+' –¥–Ω.',cls:''};
      return{text:date.toLocaleDateString('ru-RU',{day:'numeric',month:'short'}),cls:''};
    }

    function toggle(id){
      const t=tasks.find(x=>x.id===id);
      if(t){t.status=t.status==='done'?'active':'done';save();renderTasks();updateStats();}
    }

    function updateStats(){
      const active=tasks.filter(t=>t.status!=='done');
      document.getElementById('urgentCount').textContent=active.filter(t=>t.priority==='urgent').length;
      document.getElementById('importantCount').textContent=active.filter(t=>t.priority==='important').length;
      document.getElementById('inworkCount').textContent=active.filter(t=>t.priority==='inwork').length;
      const today=new Date();today.setHours(0,0,0,0);
      const tom=new Date(today);tom.setDate(tom.getDate()+1);
      document.getElementById('todayCount').textContent=active.filter(t=>t.deadline&&new Date(t.deadline)>=today&&new Date(t.deadline)<tom).length;
    }

    function clearDone(){
      tasks=tasks.filter(t=>t.status!=='done');
      save();renderTasks();updateStats();toast('üóëÔ∏è –û—á–∏—â–µ–Ω–æ');
    }

    function openEdit(id){
      const t=tasks.find(x=>x.id===id);if(!t)return;
      editingId=id;editPriority=t.priority;
      document.getElementById('editTitle').value=t.title;
      document.getElementById('editDesc').value=t.description||'';
      document.getElementById('editDeadline').value=t.deadline||'';
      document.querySelectorAll('.priority-btn').forEach(b=>b.classList.toggle('active',b.dataset.p===t.priority));
      document.getElementById('editModal').classList.add('open');
    }

    function closeEditModal(){document.getElementById('editModal').classList.remove('open');editingId=null;}

    function setPriority(p){
      editPriority=p;
      document.querySelectorAll('.priority-btn').forEach(b=>b.classList.toggle('active',b.dataset.p===p));
    }

    function saveTask(){
      const t=tasks.find(x=>x.id===editingId);if(!t)return;
      t.title=document.getElementById('editTitle').value.trim()||t.title;
      t.description=document.getElementById('editDesc').value.trim();
      t.priority=editPriority;
      t.deadline=document.getElementById('editDeadline').value||null;
      save();renderTasks();updateStats();closeEditModal();toast('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
    }

    function deleteTask(){
      if(!editingId)return;
      tasks=tasks.filter(x=>x.id!==editingId);
      save();renderTasks();updateStats();closeEditModal();toast('üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ');
    }

    function openChat(){
      document.getElementById('chatModal').classList.add('open');
      document.getElementById('navAI').classList.add('active');
      document.getElementById('navTasks').classList.remove('active');
    }
    
    function closeChat(){
      document.getElementById('chatModal').classList.remove('open');
      document.getElementById('navTasks').classList.add('active');
      document.getElementById('navAI').classList.remove('active');
    }
    
    function goTasks(){closeChat();}

    function askQ(btn){
      document.getElementById('chatInput').value=btn.textContent.replace(/^[^\s]+\s/,'');
      sendChat();
    }

    async function sendChat(){
      const inp=document.getElementById('chatInput');
      const msg=inp.value.trim();if(!msg)return;
      inp.value='';
      chatHistory.push({role:'user',content:msg});
      renderChatMsg();
      document.getElementById('suggestions').style.display='none';
      
      const chatDiv=document.getElementById('chatMessages');
      const typingEl=document.createElement('div');
      typingEl.className='chat-typing';typingEl.id='typing';typingEl.textContent='AI –¥—É–º–∞–µ—Ç...';
      chatDiv.appendChild(typingEl);chatDiv.scrollTop=chatDiv.scrollHeight;
      
      const prioNames={urgent:'–°–†–û–ß–ù–û',important:'–í–ê–ñ–ù–û',inwork:'–≤ —Ä–∞–±–æ—Ç–µ',later:'–ø–æ–∑–∂–µ'};
      const summary=tasks.map(t=>{
        const st=t.status==='done'?'‚úÖ':'‚¨ú';
        const dl=t.deadline?' –¥–æ '+t.deadline:'';
        return st+' ['+prioNames[t.priority]+'] '+t.title+dl;
      }).join('\n');
      
      const sys='–¢—ã AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∞–º–∏. –°–µ–≥–æ–¥–Ω—è: '+new Date().toLocaleDateString('ru-RU',{weekday:'long',day:'numeric',month:'long'})+'\n\n–ó–∞–¥–∞—á–∏:\n'+(summary||'–ü—É—Å—Ç–æ')+'\n\n–ü–æ–º–æ–≥–∞–π –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å, –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å, –¥–∞–≤–∞–π —Å–æ–≤–µ—Ç—ã. –ö—Ä–∞—Ç–∫–æ, –Ω–∞ —Ä—É—Å—Å–∫–æ–º, —Å —ç–º–æ–¥–∑–∏.';
      
      try{
        const res=await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({system:sys,messages:chatHistory})});
        const data=await res.json();
        document.getElementById('typing')?.remove();
        if(data.error){chatHistory.push({role:'assistant',content:'‚ùå '+data.error});}
        else{chatHistory.push({role:'assistant',content:data.content});}
        renderChatMsg();
      }catch(e){
        document.getElementById('typing')?.remove();
        chatHistory.push({role:'assistant',content:'‚ùå –ù–µ—Ç —Å–≤—è–∑–∏'});
        renderChatMsg();
      }
    }

    function renderChatMsg(){
      const c=document.getElementById('chatMessages');
      c.innerHTML=chatHistory.map(m=>'<div class="chat-msg '+m.role+'"><div class="bubble">'+esc(m.content)+'</div></div>').join('');
      c.scrollTop=c.scrollHeight;
    }

    function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
    function toast(msg){const t=document.createElement('div');t.className='toast';t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),2500)}
    
    document.getElementById('editModal').addEventListener('click',e=>{if(e.target.id==='editModal')closeEditModal()});
  </script>
</body>
</html>
