<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0a0a0f">
  <title>TaskAI</title>
  <link rel="manifest" href="/manifest.json">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--bg:#0a0a0f;--surface:#12121a;--elevated:#1a1a25;--border:#2a2a3a;--text:#f0f0f5;--text2:#8888a0;--purple:#8b5cf6;--blue:#3b82f6;--red:#ef4444;--orange:#f97316;--green:#22c55e}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
    .app{max-width:500px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column}
    header{padding:16px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);background:rgba(10,10,15,0.9);backdrop-filter:blur(20px);position:sticky;top:0;z-index:100}
    .logo{display:flex;align-items:center;gap:10px;font-weight:700;font-size:20px}
    .logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--blue),var(--purple));border-radius:10px;display:flex;align-items:center;justify-content:center}
    .header-btn{width:40px;height:40px;border:1px solid var(--border);background:var(--elevated);border-radius:10px;color:var(--text2);font-size:18px;cursor:pointer}
    .stats{padding:16px 20px;display:flex;gap:10px;overflow-x:auto}
    .stat{flex-shrink:0;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 16px;min-width:80px}
    .stat-num{font-size:24px;font-weight:700}
    .stat-num.urgent{color:var(--red)}.stat-num.today{color:var(--orange)}.stat-num.done{color:var(--green)}
    .stat-label{font-size:11px;color:var(--text2);margin-top:2px}
    .voice-section{padding:20px}
    .voice-card{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:24px;text-align:center}
    .voice-card.listening{border-color:var(--purple);box-shadow:0 0 40px rgba(139,92,246,0.2)}
    .voice-btn{width:72px;height:72px;border-radius:50%;border:none;background:linear-gradient(135deg,var(--blue),var(--purple));color:white;font-size:28px;cursor:pointer;transition:transform 0.2s}
    .voice-btn:active{transform:scale(0.95)}
    .voice-btn.listening{animation:pulse 1.5s infinite}
    @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(139,92,246,0.4)}50%{box-shadow:0 0 0 15px rgba(139,92,246,0)}}
    .voice-hint{margin-top:12px;font-size:14px;color:var(--text2)}
    .transcript{margin-top:16px;padding:14px;background:var(--elevated);border-radius:12px;font-size:14px;text-align:left;display:none}
    .transcript.show{display:block}
    .processing{margin-top:14px;color:var(--purple);font-size:14px;display:none;align-items:center;justify-content:center;gap:8px}
    .processing.show{display:flex}
    .spinner{width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--purple);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .input-section{padding:0 20px 16px;display:flex;gap:10px}
    .text-input{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:14px 16px;color:var(--text);font-size:16px;outline:none}
    .text-input:focus{border-color:var(--purple)}
    .send-btn{width:50px;background:linear-gradient(135deg,var(--blue),var(--purple));border:none;border-radius:14px;color:white;font-size:20px;cursor:pointer}
    .tasks-section{flex:1;padding:0 20px 100px}
    .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .section-title{font-size:18px;font-weight:600}
    .filters{display:flex;gap:6px}
    .filter{padding:6px 12px;background:var(--surface);border:1px solid var(--border);border-radius:20px;font-size:12px;color:var(--text2);cursor:pointer}
    .filter.active{background:var(--purple);border-color:var(--purple);color:white}
    .task-list{display:flex;flex-direction:column;gap:10px}
    .task{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:14px;animation:slideIn 0.3s}
    @keyframes slideIn{from{opacity:0;transform:translateY(8px)}}
    .task.done{opacity:0.5}.task.done .task-title{text-decoration:line-through}
    .task-header{display:flex;gap:12px;align-items:flex-start}
    .checkbox{width:22px;height:22px;border:2px solid var(--border);border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px}
    .task.done .checkbox{background:var(--green);border-color:var(--green)}
    .checkbox::after{content:'‚úì';color:white;font-size:12px;font-weight:700;opacity:0}
    .task.done .checkbox::after{opacity:1}
    .task-content{flex:1;min-width:0}
    .task-title{font-size:15px;font-weight:500;line-height:1.4}
    .task-meta{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .badge{padding:3px 8px;border-radius:6px;font-size:11px;font-weight:500}
    .badge.urgent{background:rgba(239,68,68,0.15);color:var(--red)}
    .badge.high{background:rgba(249,115,22,0.15);color:var(--orange)}
    .badge.medium{background:rgba(59,130,246,0.15);color:var(--blue)}
    .badge.low{background:rgba(34,197,94,0.15);color:var(--green)}
    .badge.deadline{background:var(--elevated);color:var(--text2)}
    .badge.overdue{background:rgba(239,68,68,0.15);color:var(--red)}
    .delete-btn{width:30px;height:30px;background:var(--elevated);border:none;border-radius:8px;color:var(--text2);font-size:14px;cursor:pointer}
    .delete-btn:hover{color:var(--red)}
    .empty{text-align:center;padding:50px 20px;color:var(--text2)}
    .empty-icon{font-size:40px;margin-bottom:12px;opacity:0.5}
    .chat-modal{position:fixed;inset:0;background:var(--bg);z-index:200;display:flex;flex-direction:column;transform:translateX(100%);transition:transform 0.3s}
    .chat-modal.open{transform:translateX(0)}
    .chat-header{padding:16px 20px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border)}
    .back-btn{width:40px;height:40px;background:var(--elevated);border:none;border-radius:10px;color:var(--text);font-size:18px;cursor:pointer}
    .chat-messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:14px}
    .suggestions{display:flex;flex-direction:column;gap:8px}
    .suggestion{padding:12px 14px;background:var(--elevated);border:1px solid var(--border);border-radius:12px;font-size:14px;color:var(--text2);cursor:pointer;text-align:left}
    .suggestion:hover{color:var(--text)}
    .chat-msg{max-width:85%;animation:slideIn 0.3s}
    .chat-msg.user{align-self:flex-end}.chat-msg.assistant{align-self:flex-start}
    .bubble{padding:12px 16px;border-radius:16px;font-size:14px;line-height:1.5;white-space:pre-wrap}
    .chat-msg.user .bubble{background:var(--purple);border-bottom-right-radius:4px}
    .chat-msg.assistant .bubble{background:var(--surface);border:1px solid var(--border);border-bottom-left-radius:4px}
    .chat-input-area{padding:16px 20px;border-top:1px solid var(--border);display:flex;gap:10px}
    .chat-input{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:14px 16px;color:var(--text);font-size:16px;outline:none}
    .chat-send{width:50px;background:linear-gradient(135deg,var(--blue),var(--purple));border:none;border-radius:14px;color:white;font-size:20px;cursor:pointer}
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:rgba(10,10,15,0.95);backdrop-filter:blur(20px);border-top:1px solid var(--border);display:flex;justify-content:center;gap:8px;padding:12px 20px;padding-bottom:max(12px,env(safe-area-inset-bottom))}
    .nav-btn{flex:1;max-width:100px;padding:8px;background:none;border:none;border-radius:10px;color:var(--text2);font-size:11px;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px}
    .nav-btn.active{color:var(--purple);background:rgba(139,92,246,0.1)}
    .nav-icon{font-size:20px}
    .toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:var(--elevated);border:1px solid var(--border);padding:12px 20px;border-radius:12px;font-size:14px;z-index:300;animation:slideIn 0.3s}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo"><div class="logo-icon">‚ö°</div><span>TaskAI</span></div>
      <button class="header-btn" onclick="openChat()">üí¨</button>
    </header>
    <div class="stats">
      <div class="stat"><div class="stat-num urgent" id="urgentCount">0</div><div class="stat-label">–°—Ä–æ—á–Ω—ã—Ö</div></div>
      <div class="stat"><div class="stat-num today" id="todayCount">0</div><div class="stat-label">–°–µ–≥–æ–¥–Ω—è</div></div>
      <div class="stat"><div class="stat-num done" id="doneCount">0</div><div class="stat-label">–ì–æ—Ç–æ–≤–æ</div></div>
    </div>
    <div class="voice-section">
      <div class="voice-card" id="voiceCard">
        <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()">üé§</button>
        <div class="voice-hint" id="voiceHint">–ù–∞–∂–º–∏ –∏ –≥–æ–≤–æ—Ä–∏ –∑–∞–¥–∞—á–∏</div>
        <div class="transcript" id="transcript"></div>
        <div class="processing" id="processing"><div class="spinner"></div><span>AI –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç...</span></div>
      </div>
    </div>
    <div class="input-section">
      <input type="text" class="text-input" id="textInput" placeholder="–ò–ª–∏ –Ω–∞–ø–∏—à–∏ –∑–∞–¥–∞—á—É..." onkeypress="if(event.key==='Enter')sendText()">
      <button class="send-btn" onclick="sendText()">‚Üí</button>
    </div>
    <div class="tasks-section">
      <div class="section-header">
        <h2 class="section-title">–ó–∞–¥–∞—á–∏</h2>
        <div class="filters">
          <button class="filter active" data-f="active" onclick="setFilter('active')">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
          <button class="filter" data-f="done" onclick="setFilter('done')">–ì–æ—Ç–æ–≤—ã–µ</button>
        </div>
      </div>
      <div class="task-list" id="taskList"></div>
    </div>
  </div>
  <div class="chat-modal" id="chatModal">
    <div class="chat-header">
      <button class="back-btn" onclick="closeChat()">‚Üê</button>
      <span style="font-weight:600;font-size:18px">AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</span>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="suggestions" id="suggestions">
        <button class="suggestion" onclick="askQ(this)">üìä –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –º–æ–∏ –∑–∞–¥–∞—á–∏</button>
        <button class="suggestion" onclick="askQ(this)">üéØ –° —á–µ–≥–æ –Ω–∞—á–∞—Ç—å —Å–µ–≥–æ–¥–Ω—è?</button>
        <button class="suggestion" onclick="askQ(this)">‚ö†Ô∏è –ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ –ø–æ–¥ —É–≥—Ä–æ–∑–æ–π?</button>
      </div>
    </div>
    <div class="chat-input-area">
      <input type="text" class="chat-input" id="chatInput" placeholder="–°–ø—Ä–æ—Å–∏..." onkeypress="if(event.key==='Enter')sendChat()">
      <button class="chat-send" onclick="sendChat()">‚Üí</button>
    </div>
  </div>
  <nav class="bottom-nav">
    <button class="nav-btn active"><span class="nav-icon">üìã</span><span>–ó–∞–¥–∞—á–∏</span></button>
    <button class="nav-btn" onclick="openChat()"><span class="nav-icon">ü§ñ</span><span>AI</span></button>
  </nav>
  <script>
    const API='/api/chat';let tasks=JSON.parse(localStorage.getItem('taskai')||'[]'),filter='active',listening=false,recognition=null,chatHistory=[];
    renderTasks();updateStats();setupSpeech();
    function setupSpeech(){if('webkitSpeechRecognition'in window||'SpeechRecognition'in window){const SR=window.SpeechRecognition||window.webkitSpeechRecognition;recognition=new SR();recognition.continuous=true;recognition.interimResults=true;recognition.lang='ru-RU';recognition.onresult=e=>{let t='';for(let i=0;i<e.results.length;i++)t+=e.results[i][0].transcript;document.getElementById('transcript').textContent=t;document.getElementById('transcript').classList.add('show')};recognition.onerror=()=>stopVoice();recognition.onend=()=>{if(listening){const t=document.getElementById('transcript').textContent;if(t.trim())processInput(t);stopVoice()}}}}
    function toggleVoice(){listening?recognition.stop():startVoice()}
    function startVoice(){listening=true;document.getElementById('voiceCard').classList.add('listening');document.getElementById('voiceBtn').classList.add('listening');document.getElementById('voiceHint').textContent='–ì–æ–≤–æ—Ä–∏—Ç–µ...';document.getElementById('transcript').textContent='';document.getElementById('transcript').classList.remove('show');recognition.start()}
    function stopVoice(){listening=false;document.getElementById('voiceCard').classList.remove('listening');document.getElementById('voiceBtn').classList.remove('listening');document.getElementById('voiceHint').textContent='–ù–∞–∂–º–∏ –∏ –≥–æ–≤–æ—Ä–∏ –∑–∞–¥–∞—á–∏'}
    async function processInput(text){if(!text.trim())return;document.getElementById('processing').classList.add('show');try{const res=await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({mode:'parse',messages:[{role:'user',content:text}]})});const data=await res.json();if(data.error)throw new Error(data.error);let newTasks=[];try{const match=data.content.match(/\[[\s\S]*\]/);if(match)newTasks=JSON.parse(match[0])}catch(e){}if(newTasks.length){newTasks.forEach(t=>{tasks.push({id:Date.now()+Math.random(),title:t.title,priority:t.priority||'medium',deadline:t.deadline,category:t.category||'other',status:'active',created:new Date().toISOString()})});save();renderTasks();updateStats();toast(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: ${newTasks.length}`)}else{toast('‚ùì –ù–µ –ø–æ–Ω—è–ª –∑–∞–¥–∞—á–∏')}}catch(e){console.error(e);toast('‚ùå –û—à–∏–±–∫–∞')}document.getElementById('processing').classList.remove('show');document.getElementById('transcript').classList.remove('show')}
    function sendText(){const inp=document.getElementById('textInput');const t=inp.value.trim();if(t){inp.value='';processInput(t)}}
    function save(){localStorage.setItem('taskai',JSON.stringify(tasks))}
    function renderTasks(){const list=document.getElementById('taskList');let f=tasks.filter(t=>filter==='active'?t.status!=='done':t.status==='done');const prio={urgent:0,high:1,medium:2,low:3};f.sort((a,b)=>{if(prio[a.priority]!==prio[b.priority])return prio[a.priority]-prio[b.priority];if(a.deadline&&b.deadline)return new Date(a.deadline)-new Date(b.deadline);return a.deadline?-1:1});if(!f.length){list.innerHTML='<div class="empty"><div class="empty-icon">üìù</div><div>–ù–µ—Ç –∑–∞–¥–∞—á</div></div>';return}const prioLabels={urgent:'üî¥ –°—Ä–æ—á–Ω–æ',high:'üü† –í–∞–∂–Ω–æ',medium:'üîµ –û–±—ã—á–Ω–æ',low:'üü¢ –ü–æ–∑–∂–µ'};list.innerHTML=f.map(t=>{const dl=deadlineInfo(t.deadline);return`<div class="task ${t.status==='done'?'done':''}" data-id="${t.id}"><div class="task-header"><div class="checkbox" onclick="toggle(${t.id})"></div><div class="task-content"><div class="task-title">${esc(t.title)}</div><div class="task-meta"><span class="badge ${t.priority}">${prioLabels[t.priority]}</span>${t.deadline?`<span class="badge deadline ${dl.cls}">üìÖ ${dl.text}</span>`:''}</div></div><button class="delete-btn" onclick="del(${t.id})">üóëÔ∏è</button></div></div>`}).join('')}
    function deadlineInfo(d){if(!d)return{text:'',cls:''};const date=new Date(d);const today=new Date();today.setHours(0,0,0,0);const diff=Math.ceil((date-today)/86400000);if(diff<0)return{text:'–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ',cls:'overdue'};if(diff===0)return{text:'–°–µ–≥–æ–¥–Ω—è',cls:'overdue'};if(diff===1)return{text:'–ó–∞–≤—Ç—Ä–∞',cls:''};if(diff<=7)return{text:`${diff} –¥–Ω.`,cls:''};return{text:date.toLocaleDateString('ru-RU',{day:'numeric',month:'short'}),cls:''}}
    function toggle(id){const t=tasks.find(x=>x.id===id);if(t){t.status=t.status==='done'?'active':'done';save();renderTasks();updateStats()}}
    function del(id){tasks=tasks.filter(x=>x.id!==id);save();renderTasks();updateStats()}
    function setFilter(f){filter=f;document.querySelectorAll('.filter').forEach(el=>el.classList.toggle('active',el.dataset.f===f));renderTasks()}
    function updateStats(){const active=tasks.filter(t=>t.status!=='done');document.getElementById('urgentCount').textContent=active.filter(t=>t.priority==='urgent').length;const today=new Date();today.setHours(0,0,0,0);const tom=new Date(today);tom.setDate(tom.getDate()+1);document.getElementById('todayCount').textContent=active.filter(t=>t.deadline&&new Date(t.deadline)>=today&&new Date(t.deadline)<tom).length;document.getElementById('doneCount').textContent=tasks.filter(t=>t.status==='done').length}
    function openChat(){document.getElementById('chatModal').classList.add('open')}
    function closeChat(){document.getElementById('chatModal').classList.remove('open')}
    function askQ(btn){document.getElementById('chatInput').value=btn.textContent.replace(/^[^\s]+\s/,'');sendChat()}
    async function sendChat(){const inp=document.getElementById('chatInput');const msg=inp.value.trim();if(!msg)return;inp.value='';chatHistory.push({role:'user',content:msg});renderChat();document.getElementById('suggestions').style.display='none';const summary=tasks.map(t=>{const st=t.status==='done'?'‚úÖ':'‚¨ú';const dl=t.deadline?` (–¥–æ ${t.deadline})`:'';return`${st} [${t.priority}] ${t.title}${dl}`}).join('\n');const sys=`–¢—ã AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –∑–∞–¥–∞—á. –°–µ–≥–æ–¥–Ω—è: ${new Date().toLocaleDateString('ru-RU')}\n\n–ó–∞–¥–∞—á–∏:\n${summary||'–ù–µ—Ç'}\n\n–ü–æ–º–æ–≥–∞–π –∫—Ä–∞—Ç–∫–æ, –Ω–∞ —Ä—É—Å—Å–∫–æ–º, —Å —ç–º–æ–¥–∑–∏.`;try{const res=await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({system:sys,messages:chatHistory})});const data=await res.json();if(data.error)throw new Error(data.error);chatHistory.push({role:'assistant',content:data.content});renderChat()}catch(e){chatHistory.push({role:'assistant',content:'‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏'});renderChat()}}
    function renderChat(){const c=document.getElementById('chatMessages');if(!chatHistory.length)return;c.innerHTML=chatHistory.map(m=>`<div class="chat-msg ${m.role}"><div class="bubble">${esc(m.content)}</div></div>`).join('');c.scrollTop=c.scrollHeight}
    function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
    function toast(msg){const t=document.createElement('div');t.className='toast';t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),2500)}
  </script>
</body>
</html>
